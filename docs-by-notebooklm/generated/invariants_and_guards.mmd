%%{init: {'theme': 'default', 'themeVariables': {'fontSize': '14px'}}}%%
flowchart TB
    subgraph Backend["Backend Invariants"]
        subgraph Positions["Positions"]
            P1["Zero-indexed"]
            P2["Deterministic order"]
            P3["Normalize on mutate"]
        end

        subgraph Safety["Circular Prevention"]
            S1["Self-parent block"]
            S2["Descendant check"]
            S3["Depth limit 100"]
        end
    end

    subgraph Frontend["Frontend Invariants"]
        subgraph Zones["DnD Zones"]
            Z1["Top 35%: before"]
            Z2["Mid 30%: on"]
            Z3["Bot 35%: after"]
        end

        subgraph Offset["Horizontal"]
            O1["+40px: indent"]
            O2["-40px: outdent"]
        end
    end

    subgraph Gates["Quality Gates"]
        direction LR
        G1["ruff"]
        G2["mypy"]
        G3["pytest"]
        G4["eslint"]
        G5["tsc"]
    end

    P1 --> P2 --> P3
    S1 --> S2 --> S3
    Z1 & Z2 & Z3

    classDef backend fill:#D1FAE5,stroke:#10B981,stroke-width:2px
    classDef frontend fill:#DBEAFE,stroke:#3B82F6,stroke-width:2px
    classDef safety fill:#FEE2E2,stroke:#EF4444,stroke-width:2px
    classDef gates fill:#FEF3C7,stroke:#F59E0B,stroke-width:2px

    class P1,P2,P3 backend
    class Z1,Z2,Z3,O1,O2 frontend
    class S1,S2,S3 safety
    class G1,G2,G3,G4,G5 gates
