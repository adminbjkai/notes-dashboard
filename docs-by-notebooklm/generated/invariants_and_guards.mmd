%%{init: {'theme': 'default'}}%%
flowchart TB
    subgraph BackendInvariants["Backend Invariants (Article I)"]
        direction TB

        subgraph PositionMgmt["Position Management"]
            SST["1.1.1 Single Source of Truth<br/>_normalize_positions()"]
            ZeroIdx["1.1.2 Zero-Indexed<br/>[0, 1, 2, ..., N-1]"]
            DetOrder["1.1.3 Deterministic Order<br/>ORDER BY position, created_at, id"]
            NormMut["1.1.4 Normalize on Mutation<br/>create/update/reorder/delete"]
        end

        subgraph CircularPrev["Circular Reference Prevention"]
            SelfPar["1.2.1 Self-Parent Block<br/>parent_id != id"]
            DescChk["1.2.2 Descendant Check<br/>_is_descendant()"]
            DepthLim["1.2.3 Depth Limit<br/>CTE depth < 100"]
        end

        subgraph AtomicOps["Atomic Operations"]
            DelAtom["1.3.1 Delete Atomicity<br/>flush + commit together"]
            ReordSafe["1.3.2 Reorder Safety<br/>temp position 999999"]
        end
    end

    subgraph FrontendInvariants["Frontend Invariants (Article II)"]
        direction TB

        subgraph DndZones["DnD Zone Strategy"]
            ZoneRule["2.1.1 The 35/30/35 Rule"]
            Zone35T["Top 35% → before"]
            Zone30M["Middle 30% → on"]
            Zone35B["Bottom 35% → after"]
        end

        subgraph HorizThresh["Horizontal Thresholds"]
            Indent["2.1.2 Indent: >+40px"]
            Outdent["Outdent: <-40px"]
            RootZone["2.1.3 Root Zone: 20px left edge"]
        end

        subgraph Validation["Client Validation"]
            InvalidTgt["2.2.1 Invalid Targets<br/>self + all descendants"]
            VisFeedback["2.2.2 Visual Feedback<br/>blue/red/indigo highlights"]
        end
    end

    subgraph QualityGates["Quality Gates (Article V)"]
        direction LR
        Ruff["ruff check ."]
        Mypy["mypy app"]
        Pytest["pytest"]
        Lint["npm run lint"]
        TypeChk["npm run type-check"]
        Guard["forbid_docs_route.sh"]
    end

    %% Connections showing flow
    SST --> ZeroIdx --> DetOrder --> NormMut
    SelfPar --> DescChk --> DepthLim
    ZoneRule --> Zone35T & Zone30M & Zone35B

    %% Source citations
    %% CONSTITUTION.md Article I: Backend Invariants
    %% CONSTITUTION.md Article II: Frontend Invariants
    %% CONSTITUTION.md Article V: Testing & Verification

    classDef backend fill:#D1FAE5,stroke:#10B981,stroke-width:2px
    classDef frontend fill:#DBEAFE,stroke:#3B82F6,stroke-width:2px
    classDef gates fill:#FEF3C7,stroke:#F59E0B,stroke-width:2px
    classDef critical fill:#FEE2E2,stroke:#EF4444,stroke-width:2px

    class SST,ZeroIdx,DetOrder,NormMut,DelAtom,ReordSafe backend
    class ZoneRule,Zone35T,Zone30M,Zone35B,Indent,Outdent,RootZone,InvalidTgt,VisFeedback frontend
    class Ruff,Mypy,Pytest,Lint,TypeChk,Guard gates
    class SelfPar,DescChk,DepthLim critical
